version: "3.9"
services:
  dispatcher:
    image: 'nginx:1.23.4-alpine'

    command: [nginx-debug, '-g', 'daemon off;']
    working_dir: /app
    volumes:
      - ${APPS_DIR}/dispatcher/config/templates:/etc/nginx/templates
      - ${APPS_DIR}/dispatcher/static:/usr/share/nginx/html
      - ${KEYS_DIR}/dispatcher/ssl/certs:/etc/ssl/certs
      - ${KEYS_DIR}/dispatcher/ssl/private:/etc/ssl/private
      - ${KEYS_DIR}/dispatcher/dh:/etc/nginx/dh

    environment:
      - NGINX_PORT=443
      - NODE_PORT=${NODE_PORT}
      - NODE_DEV_PORT=${NODE_DEV_PORT}
      - SSL_CERT_PATH=/etc/ssl/certs/nginx-selfsigned.crt
      - SSL_KEY_PATH=/etc/ssl/private/nginx-selfsigned.key
      - DHPARAM_PATH=/etc/nginx/dh/nginx-dhparam.pem

    networks:
      - nginx
      - node-mongo

    ports:
      - '443:443'
      - '444:444'

  webfront:
    image: 'node:20.2.0-alpine3.17'

    entrypoint: npm run dev -- --host --port=${NODE_PORT}
    working_dir: /app
    volumes:
      - ${APPS_DIR}/webfront:/app

    environment:
      - NODE_DEV_PORT=${NODE_DEV_PORT}
      - PROTOCOL_HEADER=x-forwarded-proto
      - HOST_HEADER=x-forwarded-host
      - ORIGIN=${SITE_ORIGIN}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_USERNAME=${MONGO_INITIAL_USERNAME}
      - MONGO_PASSWORD=${MONGO_INITIAL_PASSWORD}
      - USER_ID=${SYSTEM_INITIAL_USERNAME}
      - USER_PASSWORD=${SYSTEM_INITIAL_PASSWORD}

    networks:
      - node-mongo

    ports:
      - '${NODE_PORT}:${NODE_PORT}'
      - '${NODE_DEV_PORT}:${NODE_DEV_PORT}'

  mongo-server:
    image: 'mongo:6.0.5'

    entrypoint: docker-entrypoint.sh mongod --replSet rs0 --keyFile=/data/keyfiles/mongokey --port=${MONGO_PORT}

    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITIAL_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITIAL_PASSWORD}

    volumes:
      - ${KEYS_DIR}/mongo:/data/keyfiles/
      - ${BACKUPS_DIR}/mongo:/data/backups/
      - ${DATA_DIR}/mongo:/data/db

    networks:
      - node-mongo

    ports:
      - '${MONGO_PORT}:${MONGO_PORT}'

networks:
  node-mongo: {}
  nginx: {}
